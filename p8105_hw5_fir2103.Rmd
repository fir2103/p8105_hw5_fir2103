---
title: "p8105_hw5_fir2103"
author: "Farizah Rob"
date: "2022-11-15"
output: html_document
---

```{r}
library(tidyverse)
library(rvest)
library(httr)
library(purrr)

library(patchwork)
```


## Problem 1


## Problem 2

```{r}
homicide_data <- read_csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv")
names(homicide_data)
```

The raw data has `r nrow(homicide_data)` rows and `r ncol(homicide_data)` columns. The variable names are `r names(homicide_data)`. `uid` represents the ID variable, `victim_first` and `victim_last` are the first and last names of the victim. There are age and sex variables for the victim as well, alongisde city, state, latitude (`lat`) and (`long`). `disposition` states what whether the attacker was arrested or not and if the case is closed. 

```{r}
homicide_data <- 
  homicide_data %>%
  mutate(city_state = str_c(city, state, sep = ", ")) %>%
  mutate(city_state = ifelse(city_state == "Tulsa, AL", "Tulsa, OK", city_state))

total_homicides <- homicide_data %>%
  group_by(city_state) %>%
  summarize(total_homicides = n()) 

unsolved_homicides <- homicide_data %>%
  filter(disposition == "Closed without arrest" | disposition == "Open/No arrest") %>%
  group_by(city_state) %>%
  summarize(unsolved_homicides = n())

city_homicides <- total_homicides %>%
  left_join(unsolved_homicides) 
```

Running `prop.test`

```{r}
x <- city_homicides %>%
  filter(city_state == "Baltimore, MD") %>%
  pull(unsolved_homicides)

n <- city_homicides %>%
  filter(city_state == "Baltimore, MD") %>%
  pull(total_homicides)

prop.test(x, n) %>%
  broom::tidy() %>%
  unnest() %>%
  select(estimate, conf.low, conf.high)
```

Running `prop.test` for each city

```{r}
prop_tests <- city_homicides %>%
  group_by(city_state) %>%
  mutate(prop_test = map2(unsolved_homicides, total_homicides, ~prop.test(.x, .y) %>% broom::tidy())) %>%
  unnest() %>%
  select(city_state, estimate, conf.low, conf.high)

prop_tests
```

95% CI of the proportionof unsolved homicides by city, state

```{r}
prop_tests %>%
  ggplot(aes(x = fct_reorder(city_state, estimate), y = estimate, color = city_state)) + geom_point() + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + 
  theme(legend.position = "none", axis.text.x = element_text(angle = 90)) +
  labs(x = "City, State", title = "95% CI's of proportion of unsolved homicides by city, state")
```

## Problem 3

Emily's code
```{r}
sim_function <- function(n = 30, mu = 0, sigma = 5) {
  sim_data <- tibble(x = rnorm(n, mean = mu, sd = sigma), )
  
  sim_data %>%
    summarize(
      mu_hat = mean(x), 
      p_value = (broom::tidy(t.test(x, mu = 0, conf.level = 0.95))$p.value))

}

output <- tibble()

for (i in 1:5000) {
  output <- bind_rows(output, sim_function(mu = 0))
}
```


Do the same for mu = 1,2,3,4,5,6

```{r}
sim_results_new <- 
  expand_grid(
    mu_list = c(1,2,3,4,5,6),
    iter = 1:5000
  ) %>%
    mutate(
      output_new = map(.x = mu_list, ~sim_function(mu = .x)),
      ) %>%
  unnest(output_new)
```

Make a plot showing the proportion of times the null was rejected (the power of the test) on the y axis and the true value of μ on the x axis. Describe the association between effect size and power.

```{r}
sim_results_new <- sim_results_new %>%
  mutate(rejected = ifelse(p_value <= 0.05, 1, 0)) 

sim_results_new %>%
  group_by(mu_list) %>%
  mutate(power = mean(rejected)) %>%
  ggplot(aes(x = mu_list, y = power)) + geom_line() + geom_point()

```

Power increases with effect size.

Make a plot showing the average estimate of μ̂
 on the y axis and the true value of μ
 on the x axis. Make a second plot (or overlay on the first) the average estimate of μ̂
 only in samples for which the null was rejected on the y axis and the true value of μ
 on the x axis. Is the sample average of μ̂
 across tests for which the null is rejected approximately equal to the true value of μ
? Why or why not?

```{r}
plot_first <- 
  sim_results_new %>%
  group_by(mu_list) %>%
  mutate(avg_mu_hat = mean(mu_hat)) %>%
  ggplot(aes(x = mu_list, y = avg_mu_hat, color = "red")) + 
  geom_point() + 
  geom_line() + 
  labs(y = "Average Mu_Hat", x = expression(~mu), title = "Average Estimate of mu_hat against true value of mu") + 
  theme(legend.position = "none")

plot_second <- 
  sim_results_new %>%
  filter(rejected == 1) %>%
  group_by(mu_list) %>%
  mutate(avg_mu_hat = mean(mu_hat)) %>%
  ggplot(aes(x = mu_list, y = avg_mu_hat, color = "blue")) + geom_point() + 
  geom_line() +
  labs(y = "Average Mu_Hat", x = expression(~mu), title = "Average Estimate of mu_hat against true value of mu \n in samples where null was rejected") + 
  theme(legend.position = "none")

plot_first
plot_second

```


